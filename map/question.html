<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>WFD é¢˜ç›®</title>
  <style>
    body {
      margin: 0;
      background: #0d1220;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: "Consolas", "Courier New", ui-monospace, SFMono-Regular, Menlo, Monaco, "Ubuntu Mono", monospace;
      color: #fff;
    }
    .panel {
      width: 520px;
      min-height: 460px;
      background: radial-gradient(circle at top, #141b2d 0%, #0c101a 55%, #090b10 100%);
      border: 4px solid #40a9ff;
      border-radius: 14px;
      box-shadow: 0 10px 35px rgba(0,0,0,.3);
      padding: 18px 18px 14px;
    }
    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 14px;
      margin-bottom: 16px;
    }
    .hearts span {
      color: #ff6b81;
      margin-left: 4px;
    }
    .title {
      text-align: center;
      font-size: 20px;
      letter-spacing: .08em;
      margin-bottom: 12px;
      text-transform: lowercase;
    }
    .audio-box {
      background: rgba(255,255,255,.03);
      border: 1px solid rgba(64,169,255,.14);
      border-radius: 10px;
      padding: 8px;
      margin-bottom: 10px;
    }
    audio { width: 100%; }
    .hint {
      font-size: 12px;
      opacity: .55;
      margin-bottom: 8px;
    }
    textarea {
      width: 100%;
      min-height: 120px;
      background: rgba(0,0,0,.35);
      border: 1px solid rgba(64,169,255,.25);
      border-radius: 8px;
      color: #fff;
      padding: 8px;
      outline: none;
      font-size: 14px;
    }
    textarea:focus {
      border-color: rgba(64,169,255,.85);
      box-shadow: 0 0 0 2px rgba(64,169,255,.16);
    }
    .btn {
      width: 100%;
      margin-top: 10px;
      background: linear-gradient(120deg, #40a9ff 0%, #1890ff 100%);
      border: none;
      border-radius: 8px;
      color: #fff;
      font-weight: 600;
      padding: 9px 0;
      cursor: pointer;
      font-size: 14px;
      letter-spacing: .02em;
      box-shadow: 0 6px 20px rgba(24,144,255,.35);
    }
    .btn:active { transform: translateY(1px); }
    .warn {
      margin-top: 6px;
      font-size: 12px;
      color: #ffb;
      display: none;
    }
    .footer-line {
      margin-top: 10px;
      font-size: 11px;
      opacity: .4;
      display: flex;
      justify-content: space-between;
    }
  </style>
</head>
<body>
  <div class="panel">
    <div class="topbar">
      <div class="hearts" id="hpView">HP:</div>
      <div id="progress">1 / 1</div>
    </div>

    <div class="title" id="titleText">write from dictation</div>

    <div class="audio-box">
      <audio id="audio" controls></audio>
      <p id="noaudio" class="warn">è¿™é¢˜æ²¡æœ‰éŸ³é¢‘ï¼Œç›´æ¥å†™æ–‡å­—ç­”æ¡ˆå°±è¡Œ</p>
    </div>

    <p class="hint">è¦æ±‚ï¼šæ‰€æœ‰æ­£ç¡®å•è¯éƒ½è¦å†™åˆ°ï¼›å¯ä»¥å¤šå†™ï¼›å¤§å°å†™è¦å’ŒåŸå¥ä¸€æ ·ï¼Œç‰¹åˆ«æ˜¯é¦–å­—æ¯ã€‚</p>
    <textarea id="user" placeholder="åœ¨è¿™é‡Œå†™ä½ å¬åˆ°çš„å¥å­..."></textarea>
    <button class="btn" id="submit">æäº¤</button>

    <div class="footer-line">
      <span id="footerNode">node: --</span>
      <span id="footerBoss">normal</span>
    </div>
  </div>

  <script>
    // å–åœ°å›¾ä¼ æ¥çš„ä¿¡æ¯
    const pending = JSON.parse(localStorage.getItem('pendingQuestion') || 'null');
    if (!pending) {
      alert('æ²¡æœ‰è¦åšçš„é¢˜ï¼Œè¿”å›åœ°å›¾');
      window.location = 'map1.html';
    }

    // å½“å‰è¡€é‡
    let hp = Number(localStorage.getItem('rogueHP') || '3');
    function renderHP() {
      const hpView = document.getElementById('hpView');
      hpView.innerHTML = 'HP: ' + (hp > 0 ? 'â¤ï¸ '.repeat(hp) : 'ğŸ’€');
    }
    renderHP();

    document.getElementById('progress').textContent = '1 / 1';
    document.getElementById('footerNode').textContent = 'node: ' + pending.nodeId;
    document.getElementById('footerBoss').textContent = pending.boss ? 'BOSS' : 'normal';

    const fileMap = {
      1: 'data/wfd_map1.json',
      2: 'data/wfd_map2.json',
      3: 'data/wfd_map3.json'
    };

    let correctText = '';
    let currentQuestionId = null; // ç”¨æ¥å­˜è¿™é¢˜çš„ id

    // å°å·¥å…·
    function stripPunc(s) {
      return s.replace(/[.,!?]/g, '');
    }
    function tokenize(s) {
      return stripPunc(s).split(/\s+/).filter(Boolean);
    }

    // è¯»å–è¿™ä¸€å¼ åœ°å›¾å·²ç»å‡ºè¿‡çš„é¢˜
    const usedKey = 'usedQuestions_map_' + pending.map;
    let used = JSON.parse(localStorage.getItem(usedKey) || '[]');

    // æ‹‰é¢˜åº“
    fetch(fileMap[pending.map])
      .then(r => r.json())
      .then(list => {
        // è¿‡æ»¤æ‰å·²ç»ç”¨è¿‡çš„é¢˜
        const remaining = list.filter(q => !used.includes(q.id));
        let q;
        if (remaining.length > 0) {
          q = remaining[Math.floor(Math.random() * remaining.length)];
        } else {
          // å…¨éƒ¨å‡ºè¿‡ä¸€éäº†ï¼Œå°±æ¸…ç©ºé‡æ–°æ¥
          used = [];
          localStorage.setItem(usedKey, JSON.stringify(used));
          q = list[Math.floor(Math.random() * list.length)];
        }

        currentQuestionId = q.id;
        correctText = (q.answer || '').trim();

        // éŸ³é¢‘è·¯å¾„å¤„ç†
        let src = q.audio || '';
        src = src.replace('../audio/', './audio/').replace('..\\audio\\', '.\\audio\\');
        const audioEl = document.getElementById('audio');
        audioEl.src = src;
        audioEl.onerror = function() {
          document.getElementById('noaudio').style.display = 'block';
        };
      });

    document.getElementById('submit').onclick = function () {
      const userRaw = document.getElementById('user').value.trim();

      // ===== åˆ¤åˆ† =====
      const correctFirst = correctText.charAt(0);
      const userFirst = userRaw.charAt(0);
      let isCorrect = true;

      if (userFirst !== correctFirst) {
        isCorrect = false;
      } else {
        const ansWords = tokenize(correctText);
        const userWords = tokenize(userRaw);
        for (const aw of ansWords) {
          if (!userWords.includes(aw)) {
            isCorrect = false;
            break;
          }
        }
      }

      // ===== æ‰£è¡€ & ä¿å­˜è¡€é‡ =====
      if (!isCorrect) {
        hp = hp - 1;
        if (hp < 0) hp = 0;
        localStorage.setItem('rogueHP', String(hp));
      }
      renderHP();

      // ===== âœ… åŠ åé¦ˆ =====
      if (isCorrect) {
        alert('âœ… Correct!');
      } else {
        alert('âŒ Wrong!\næ­£ç¡®å¥å­æ˜¯ï¼š\n' + correctText);
      }

      // ===== è®°å½•è¿™é“é¢˜å·²ç»å‡ºè¿‡ =====
      if (currentQuestionId !== null) {
        used.push(currentQuestionId);
        localStorage.setItem(usedKey, JSON.stringify(used));
      }

      // ===== å†™å›ç»™åœ°å›¾ =====
      localStorage.setItem('questionResult', JSON.stringify({
        map: pending.map,
        nodeId: pending.nodeId,
        boss: pending.boss,
        correct: isCorrect
      }));

      // è¿”å›åœ°å›¾
      window.location = 'map' + pending.map + '.html';
    };
  </script>
</body>
</html>
